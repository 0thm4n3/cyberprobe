<html>
<body>

<div id="place">
</div>

</body>
</html>

<script language="JavaScript">

var width = 1400;

var height = 1000;

// Update period, in milliseconds.
var rejig_period = 100;
var db_check_period = 5000;
//var db_next_item_time = 200;

var last_oid = 0;

var observations = new Array();

function get_oldest_oid() {

  var cli = new XMLHttpRequest();
  var url = "http://localhost:9200/cybermon/observation/_search";

  var body = '  { "from" : 0, "size" : 1, "fields" : ["observation.oid"], "sort" : [ { "observation.oid" : {"order" : "asc"} }], "query" : {        "match_all" : {}  }}';

  cli.open("POST", url, false);
  cli.send(body);
  var resp = eval('(' + cli.responseText + ')');

  return resp.hits.hits[0].fields["observation.oid"];

}

function pos(time, now) {
  return width - 8 * (now - time);
}

last_oid = get_oldest_oid();
attempts = 10;

function db_check() {

  var now = new Date();
  now = now.getTime() / 1000;

  while (1) {

    var cli = new XMLHttpRequest();
    var url = "http://localhost:9200/cybermon/observation/" + last_oid;

    cli.open("GET", url, false);
    cli.send();

    var resp = eval('(' + cli.responseText + ')');

    if (!resp.exists) {

      attempts--;

      if (attempts == 0)
        last_oid++;
      
      break;
    }

    var liid = resp._source.observation.liid;
    var action = resp._source.observation.action;
    var oid = resp._source.observation.oid;
    var time = resp._source.observation.time;

    var obs = {};
    obs["time"] = time;
    obs["liid"] = liid;
    obs["y"] = (oid * 45102529) % height;
    obs["x"] = pos(now, time);

    var div = document.createElement("div");
    div.appendChild(document.createTextNode(oid + " " + action));
    obs["element"] = div;

    if (action == "connected_up") {
      last_oid++; continue;
    }

    if (action == "connected_down") {
      last_oid++; continue;
    }
    
    if (action == "http_response") {
      var ct = resp._source.observation.header["Content-Type"];
      if (ct == "image/jpeg" || ct == "image/gif" || ct == "image/png") {

        div.appendChild(document.createElement("br"));
        var img = document.createElement("img");
        img.style["width"] = "50px";
        img.src = "data:" + ct + ";base64," + resp._source.observation.body;

        div.appendChild(img);
      }
    }
    
    if (obs["x"] >= 0) {

      observations.push(obs);
      place(obs);

    }
    
    last_oid += 1;
    attempts = 10;

  }

  setTimeout(db_check, db_check_period);
 
}

function place(obs) {

    var elt = obs["element"];

    elt.style["left"] = obs["x"] + "px";
    elt.style["top"] = obs["y"] + "px";
    elt.style["position"] = "absolute";
    elt.style["border"] = "1px solid black";
    elt.style["background"] = "white";
    elt.style["font"] = "7pt courier";

    document.getElementById("place").appendChild(elt);

}

function rejig() {

  var now = new Date();
  now = now.getTime() / 1000;

  for(i in observations) {
    var obs = observations[i];
    var elt = obs["element"];

    obs["x"] = pos(obs.time, now);

    if (obs["x"] < 0) {
      elt.parentNode.removeChild(elt);
      observations.splice(i, 1);
      i--;
    } else 
      elt.style["left"] = obs["x"] + "px";

  }

  setTimeout(rejig, rejig_period);

}

db_check();
rejig();

</script>

